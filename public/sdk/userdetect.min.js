/**
 * UserDetect SDK v3.0.0
 * Silent location intelligence — no permission prompts.
 * Collects: fingerprint, language, timezone, network, fonts, screen.
 * Usage: UserDetect.init('api_key', callback, options);
 */
var UserDetect = (function () {
    'use strict';

    var _apiKey = null;
    var _options = {};
    var _callback = null;
    var _lastDetection = null;
    var _fingerprint = null;
    var _initialized = false;

    var DEFAULTS = {
        apiEndpoint: '',
        timeout: 15000,
        debug: false,
        autoDetect: true,
        returnAlternatives: false
    };

    // ---- Fingerprint ----

    function sha256(str) {
        var buffer = new TextEncoder().encode(str);
        return crypto.subtle.digest('SHA-256', buffer).then(function (hashBuffer) {
            var hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(function (b) { return b.toString(16).padStart(2, '0'); }).join('');
        });
    }

    function getCanvasFingerprint() {
        try {
            var canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 50;
            var ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('UserDetect,fp!', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('UserDetect,fp!', 4, 17);
            ctx.beginPath();
            ctx.arc(50, 25, 10, 0, Math.PI * 2);
            ctx.fillStyle = '#f0f';
            ctx.fill();
            return canvas.toDataURL();
        } catch (e) { return ''; }
    }

    function getWebGLFingerprint() {
        try {
            var canvas = document.createElement('canvas');
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return '';
            var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            var vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : '';
            var renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : '';
            return vendor + '~' + renderer;
        } catch (e) { return ''; }
    }

    function getAudioFingerprint() {
        try {
            var AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) return '';
            var context = new AC();
            var analyser = context.createAnalyser();
            var data = new Float32Array(analyser.frequencyBinCount);
            analyser.getFloatFrequencyData(data);
            context.close();
            return Array.from(data.slice(0, 30)).join(',');
        } catch (e) { return ''; }
    }

    // ---- Regional Font Detection ----

    function detectFonts() {
        var baseFonts = ['monospace', 'sans-serif', 'serif'];

        // Standard fonts + Indian regional fonts for state-level detection
        var testFonts = [
            // Standard
            'Arial', 'Courier New', 'Georgia', 'Times New Roman', 'Trebuchet MS',
            'Verdana', 'Comic Sans MS', 'Impact', 'Lucida Console', 'Tahoma',
            'Palatino', 'Garamond', 'Calibri',
            // Gujarati
            'Lohit Gujarati', 'Noto Sans Gujarati', 'Shruti', 'Gujarati Sangam MN',
            // Tamil
            'Lohit Tamil', 'Noto Sans Tamil', 'Tamil Sangam MN', 'InaiMathi',
            // Telugu
            'Lohit Telugu', 'Noto Sans Telugu', 'Telugu Sangam MN',
            // Devanagari (Hindi/Marathi)
            'Lohit Devanagari', 'Noto Sans Devanagari', 'Mangal', 'Devanagari Sangam MN',
            // Bengali
            'Lohit Bengali', 'Noto Sans Bengali', 'Bangla Sangam MN', 'Vrinda',
            // Kannada
            'Lohit Kannada', 'Noto Sans Kannada', 'Kannada Sangam MN', 'Tunga',
            // Malayalam
            'Lohit Malayalam', 'Noto Sans Malayalam', 'Malayalam Sangam MN', 'Kartika',
            // Punjabi (Gurmukhi)
            'Lohit Punjabi', 'Noto Sans Gurmukhi', 'Gurmukhi Sangam MN', 'Raavi',
            // Odia
            'Lohit Odia', 'Noto Sans Oriya', 'Oriya Sangam MN', 'Kalinga'
        ];

        var testString = 'mmmmmmmmlli';
        var span = document.createElement('span');
        span.style.fontSize = '72px';
        span.style.position = 'absolute';
        span.style.left = '-9999px';
        span.textContent = testString;
        document.body.appendChild(span);

        var baseWidths = {};
        baseFonts.forEach(function (f) { span.style.fontFamily = f; baseWidths[f] = span.offsetWidth; });

        var detected = [];
        testFonts.forEach(function (font) {
            var found = baseFonts.some(function (base) {
                span.style.fontFamily = "'" + font + "', " + base;
                return span.offsetWidth !== baseWidths[base];
            });
            if (found) detected.push(font);
        });

        document.body.removeChild(span);
        return detected;
    }

    // ---- Regional Language Analysis ----

    function analyzeLanguages() {
        var langs = navigator.languages ? Array.from(navigator.languages) : [navigator.language || 'en'];

        // Extract regional language codes
        var regionalLangs = [];
        var langMap = {
            'gu': 'Gujarati', 'gu-IN': 'Gujarati',
            'ta': 'Tamil', 'ta-IN': 'Tamil',
            'te': 'Telugu', 'te-IN': 'Telugu',
            'mr': 'Marathi', 'mr-IN': 'Marathi',
            'bn': 'Bengali', 'bn-IN': 'Bengali',
            'kn': 'Kannada', 'kn-IN': 'Kannada',
            'ml': 'Malayalam', 'ml-IN': 'Malayalam',
            'pa': 'Punjabi', 'pa-IN': 'Punjabi',
            'or': 'Odia', 'or-IN': 'Odia',
            'as': 'Assamese', 'as-IN': 'Assamese',
            'hi': 'Hindi', 'hi-IN': 'Hindi',
            'ur': 'Urdu', 'ur-IN': 'Urdu',
            'sa': 'Sanskrit', 'sa-IN': 'Sanskrit',
            'ne': 'Nepali', 'ne-IN': 'Nepali',
            'kok': 'Konkani', 'kok-IN': 'Konkani',
            'mai': 'Maithili', 'mai-IN': 'Maithili',
            'sd': 'Sindhi', 'sd-IN': 'Sindhi',
            'doi': 'Dogri', 'doi-IN': 'Dogri',
            'mni': 'Manipuri', 'mni-IN': 'Manipuri',
            'sat': 'Santali', 'sat-IN': 'Santali',
            'bho': 'Bhojpuri', 'bho-IN': 'Bhojpuri'
        };

        langs.forEach(function (lang, index) {
            var code = lang.toLowerCase().split('-')[0];
            var fullCode = lang.toLowerCase();

            // Check both base code and full code
            if (langMap[fullCode]) {
                regionalLangs.push({ code: lang, language: langMap[fullCode], position: index });
            } else if (langMap[code]) {
                regionalLangs.push({ code: lang, language: langMap[code], position: index });
            }
        });

        return {
            raw: langs,
            primary: langs[0] || null,
            regional: regionalLangs,
            has_indian_lang: regionalLangs.length > 0
        };
    }

    // ---- Network Information ----

    function getNetworkInfo() {
        var info = { type: null, effectiveType: null, rtt: null, downlink: null, saveData: false };

        try {
            var conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (conn) {
                info.type = conn.type || null;                    // wifi, cellular, ethernet
                info.effectiveType = conn.effectiveType || null;  // 4g, 3g, 2g, slow-2g
                info.rtt = conn.rtt || null;                      // round-trip time in ms
                info.downlink = conn.downlink || null;            // megabits per second
                info.saveData = conn.saveData || false;           // data saver mode
            }
        } catch (e) { }

        return info;
    }

    // ---- Session Management ----

    function getSessionId() {
        try {
            var sid = sessionStorage.getItem('__ud_sid');
            if (!sid) {
                sid = 'sid_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 8);
                sessionStorage.setItem('__ud_sid', sid);
            }
            return sid;
        } catch (e) {
            return 'sid_' + Date.now().toString(36);
        }
    }

    function getVisitCount() {
        try {
            var count = parseInt(localStorage.getItem('__ud_vc') || '0', 10) + 1;
            localStorage.setItem('__ud_vc', count.toString());
            return count;
        } catch (e) { return 1; }
    }

    // ---- Fingerprint Generation ----

    function generateFingerprint() {
        try {
            var cached = sessionStorage.getItem('__ud_fp');
            if (cached) return Promise.resolve(cached);
        } catch (e) { }

        var components = [
            getCanvasFingerprint(),
            getWebGLFingerprint(),
            getAudioFingerprint(),
            screen.width + 'x' + screen.height + 'x' + screen.colorDepth + 'x' + (window.devicePixelRatio || 1),
            (function () { try { return Intl.DateTimeFormat().resolvedOptions().timeZone; } catch (e) { return ''; } })(),
            navigator.language,
            navigator.platform,
            navigator.hardwareConcurrency || 0,
            navigator.deviceMemory || 0,
            navigator.maxTouchPoints || 0,
            new Date().getTimezoneOffset()
        ];

        var raw = components.join('|||');
        return sha256(raw).then(function (hash) {
            try { sessionStorage.setItem('__ud_fp', hash); } catch (e) { }
            return hash;
        });
    }

    // ---- Signal Collection ----

    function collectSignals(fingerprint) {
        var fonts = detectFonts();
        var langAnalysis = analyzeLanguages();
        var networkInfo = getNetworkInfo();

        return {
            fingerprint: fingerprint,
            session_id: getSessionId(),
            visit_count: getVisitCount(),

            // Timezone & locale
            timezone: (function () { try { return Intl.DateTimeFormat().resolvedOptions().timeZone; } catch (e) { return null; } })(),
            timezone_offset: new Date().getTimezoneOffset(),

            // Language intelligence (key for state detection)
            language: navigator.language || null,
            languages: langAnalysis.raw,
            language_analysis: langAnalysis,

            // Device info
            user_agent: navigator.userAgent,
            screen: {
                width: screen.width,
                height: screen.height,
                color_depth: screen.colorDepth,
                pixel_ratio: window.devicePixelRatio || 1
            },
            platform: navigator.platform || null,
            hardware_concurrency: navigator.hardwareConcurrency || null,
            device_memory: navigator.deviceMemory || null,
            max_touch_points: navigator.maxTouchPoints || 0,

            // Network intelligence
            network: networkInfo,

            // Font detection (regional fonts → state hints)
            detected_fonts: fonts,
            regional_fonts: fonts.filter(function (f) {
                return f.indexOf('Lohit') !== -1 ||
                    f.indexOf('Noto Sans') !== -1 ||
                    f.indexOf('Sangam') !== -1 ||
                    f.indexOf('Shruti') !== -1 ||
                    f.indexOf('Mangal') !== -1 ||
                    f.indexOf('Vrinda') !== -1 ||
                    f.indexOf('Tunga') !== -1 ||
                    f.indexOf('Kartika') !== -1 ||
                    f.indexOf('Raavi') !== -1 ||
                    f.indexOf('Kalinga') !== -1 ||
                    f.indexOf('InaiMathi') !== -1;
            }),

            // Performance hints
            connection_quality: (function () {
                try {
                    var perf = performance.getEntriesByType('navigation')[0];
                    if (perf) {
                        return {
                            dns_lookup: Math.round(perf.domainLookupEnd - perf.domainLookupStart),
                            tcp_connect: Math.round(perf.connectEnd - perf.connectStart),
                            ttfb: Math.round(perf.responseStart - perf.requestStart),
                            page_load: Math.round(perf.loadEventEnd - perf.navigationStart)
                        };
                    }
                } catch (e) { }
                return null;
            })()
        };
    }

    // ---- API Client ----

    function makeRequest(url, headers, body, timeout) {
        var controller = new AbortController();
        var timeoutId = setTimeout(function () { controller.abort(); }, timeout);

        return fetch(url, {
            method: 'POST',
            headers: headers,
            body: body,
            signal: controller.signal
        }).then(function (response) {
            clearTimeout(timeoutId);
            if (!response.ok) {
                return response.json().catch(function () { return {}; }).then(function (data) {
                    return { success: false, error: data.error || { code: 'HTTP_ERROR', message: 'HTTP ' + response.status } };
                });
            }
            return response.json();
        }).catch(function (err) {
            clearTimeout(timeoutId);
            throw err;
        });
    }

    function sendDetection(apiKey, signals, options) {
        var endpoint = (options.apiEndpoint || '').replace(/\/$/, '') + '/v1/detect';
        var timeout = options.timeout || 15000;
        var body = JSON.stringify({
            signals: signals,
            options: {
                return_alternatives: options.returnAlternatives || false,
                include_debug_info: options.debug || false
            }
        });
        var headers = { 'Content-Type': 'application/json', 'X-API-Key': apiKey };

        return makeRequest(endpoint, headers, body, timeout).catch(function () {
            return new Promise(function (resolve) { setTimeout(resolve, 1000); }).then(function () {
                return makeRequest(endpoint, headers, body, timeout);
            });
        }).catch(function (err) {
            return { success: false, error: { code: 'NETWORK_ERROR', message: err.message || 'Failed to connect.' } };
        });
    }

    // ---- Endpoint Detection ----

    function detectApiEndpoint() {
        try {
            var scripts = document.getElementsByTagName('script');
            for (var i = scripts.length - 1; i >= 0; i--) {
                var src = scripts[i].src || '';
                if (src.indexOf('userdetect') !== -1) {
                    var url = new URL(src);
                    return url.origin + '/api';
                }
            }
        } catch (e) { }
        return window.location.origin + '/api';
    }

    // ---- Public API ----

    function init(apiKey, callback, options) {
        if (!apiKey) { console.error('[UserDetect] API key required.'); return; }
        if (typeof callback !== 'function') { console.error('[UserDetect] Callback required.'); return; }

        _apiKey = apiKey;
        _callback = callback;
        _options = {};
        for (var k in DEFAULTS) _options[k] = DEFAULTS[k];
        if (options) { for (var k in options) _options[k] = options[k]; }
        _initialized = true;

        if (!_options.apiEndpoint) _options.apiEndpoint = detectApiEndpoint();
        if (_options.debug) console.log('[UserDetect] v3.0.0 — Silent Signal Intelligence', _options);
        if (_options.autoDetect) detect().catch(function (e) { if (_options.debug) console.error('[UserDetect]', e); });
    }

    function detect() {
        if (!_initialized) return Promise.reject(new Error('SDK not initialized'));
        if (_options.debug) console.log('[UserDetect] Starting silent detection...');

        return generateFingerprint().then(function (fp) {
            _fingerprint = fp;
            var signals = collectSignals(fp);
            if (_options.debug) {
                console.log('[UserDetect] Fingerprint:', fp);
                console.log('[UserDetect] Languages:', signals.language_analysis);
                console.log('[UserDetect] Regional fonts:', signals.regional_fonts);
                console.log('[UserDetect] Network:', signals.network);
                console.log('[UserDetect] Visit #' + signals.visit_count);
            }
            return sendDetection(_apiKey, signals, _options);
        }).then(function (result) {
            _lastDetection = result;
            if (_options.debug) console.log('[UserDetect] Result:', result);
            if (_callback) _callback(result);
            return result;
        });
    }

    function getUserId() { return _fingerprint; }
    function getLastDetection() { return _lastDetection; }

    return {
        init: init,
        detect: detect,
        getUserId: getUserId,
        getLastDetection: getLastDetection
    };
})();
